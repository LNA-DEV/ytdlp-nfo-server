name: Build Browser Addon

on:
  push:
    tags: ["v*"]

jobs:
  build-addon:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set version from tag
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          cd browser-addon
          jq --arg v "$VERSION" '.version = $v' manifest.json > manifest.tmp && mv manifest.tmp manifest.json

      - name: Create addon ZIP
        run: |
          cd browser-addon
          mkdir -p dist
          zip -r dist/ytdlp-nfo-server-addon-${{ github.ref_name }}.zip \
            manifest.json popup.html popup.css popup.js icons/

      - name: Upload release artifact
        uses: softprops/action-gh-release@v2
        with:
          files: browser-addon/dist/ytdlp-nfo-server-addon-${{ github.ref_name }}.zip
